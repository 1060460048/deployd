#!/usr/bin/env node

/**
 * Dependencies
 */

var program = require('commander')
  , dpd = require('../')

// Options

program
  .version('0.3.0-pre')
  .option('-j, --json', 'output as json')
  .option('-p, --port <port>', 'specify the port (2403)')
  .option('-s, --storage <url>', 'specify where to store resources (mongodb://localhost/deployd)')
;

/**
 * A method to output json.
 */

function json(obj) {
  if(program && program.json) process.stdout.write(JSON.stringify(obj));
}

/**
 * Silent if in json mode.
 */
 
function log() {
  if(!program.json) console.log.apply(console, arguments);
}

/**
 * List all administration keys (users).
 */

program
  .command('keys')
  .description(' - list all admin keys')
  .action(function () {
    var port = program.port || 2403;

    if(program.storage) {
      dpd.storage(program.storage);
    }

    dpd.use('http://localhost:' + port).use('/keys').get(function (err, keys) {

      json(keys);
      log(keys || 'no keys found! see dpd --help');
      
      process.exit();
    })
  })

/**
 * Add a new admin key.
 */

program
  .command('addkey [key]')
  .description(" - add a new admin key eg. dpd addkey '{\"user\": \"foo\", \"label\": \"admin\"}'")
  .action(function (key) {
    try {
      key = JSON.parse(key);
    } catch(e) {
      key = undefined;
    }
    
    var strength = Math.floor(Math.random() * 5) + 2;
    
    while(strength--) {
      key[keygen()] = keygen() + keygen() + keygen();
    }
    
    if(typeof key == 'object') {
      if(program.storage) {
        dpd.storage(program.storage);
      }
      
      var port = program.port || 2403;
      
      dpd.use('http://localhost:' + port).use('/keys').post(key, function (err, newKey) {
        if(err) {
          json(err);
          log('Could not add key', err);
        } else {
          log('added key', newKey);          
        }
        process.exit();
      })
    } else {
      var msg = 'key must be a valid JSON object with more than one attribute!';
      json(new Error(msg))
      log(msg);
    }
  })
;

/**
 * Keygen
 */
 
function keygen() {
  // TODO added randomness
  return Math.random().toString().split('.')[1];
}

/**
 * Generate a key
 */
 
program
  .command('key')
  .description(" - generate, add, and print a random admin key")
  .action(function () {
    
    var port = program.port || 2403;
    var key = {}, strength = Math.floor(Math.random() * 5) + 2;
    
    while(strength--) {
      key[keygen()] = keygen() + keygen() + keygen();
    }
    
    dpd.use('http://localhost:' + port).use('/keys').post(key, function (err, newKey) {
      if(err) {
        json(err);
        log('Could not add key', err);
      } else {
        json(newKey);
        log('added key:\n\n' + JSON.stringify(newKey) + '\n');          
      }
      process.exit();
    })
  })
;

/**
 * Remove an admin key by id.
 */

 program
   .command('rm [query]')
   .description(" - remove an admin key by query'")
   .action(function (query) {
     if(!query) return console.log('you must provide the _id of they key you want to remove');
     
     // parse the query
     query = JSON.parse(query);
     
     if(program.storage) {
       dpd.storage(program.storage);
     }
     
     if(Object.keys(query) < 1) throw 'use `dpd reset` to clear all keys';
     
     var port = program.port || 2403;
     
     dpd.use('http://localhost:' + port).use('/keys').del(query, function (err) {
       if(err) {
         json(err);
         log(err);
       } else {
         json({removed: query});
         log('removed all keys matching the given query');
       }
       process.exit();
     })
   });

/**
* Remove all admin keys.
*/

program
  .command('reset')
  .description(" - remove all admin keys by query (cannot be undone)'")
  .action(function () {

    if(program.storage) {
      dpd.storage(program.storage);
    }
    
    var port = program.port || 2403;

    dpd.use('http://localhost:' + port).use('/keys').del(function (err) {
      if(err) {
        json(err);
        log(err);
      } else {
        json({removed: 'all'});
        log('removed all keys');
      }
      process.exit();
    })
  });


/**
 * Start the http server and listen.
 */

program
  .command('listen')
  .description(' - start listening over http at the provided port')
  .action(function (cmd) {
    
    var port = program.port || 2403;
    
    if(program.storage) {
      dpd.storage(program.storage);
    }

    dpd.use('http://localhost:' + port).listen(function () {
      json({port: port, storage: dpd.storage()});
      log('deployd is listening on port %s and storing resources at %s', port, dpd.storage());
    });
  })
;

// Parse

program.parse(process.argv);