var dpd = require('deployd')
  , app = require('express').createServer()
;

app.use(function(req, res, next) {
  dpd.emit('req', req, res, next);
  next();   
});

dpd.on('ready', function(config)
  dpd.emit('middleware', app);
  dpd.emit('routes', app);

  app.use(function(req, res, next) {
    res.errors = [];
    
    res.error = function(name) {
      // TODO support debug mode vs production
      // enable stack traces in debug
      res.errors.push(new Error(name));
    }
        
    dpd.emit('res', req, res, next);
    if(res.errors.length) {
      res.send({errors: res.errors});
    } else {
      next(); 
    }
  });
  
  app.listen(config.deployd.port);
  
  console.info('deployd is listening on', config.deployd.host, 'port', config.deployd.port);
  
  dpd.emit('listening', app);
});